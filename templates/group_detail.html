{% extends "base.html" %}

{% block content %}
    <!-- Bootstrap-styled header -->
    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
        <div>
            <!-- Group title -->
            <h2 class="mb-0">{{ group.name }}</h2>
            <!-- Group subject -->
            <p class="lead text-muted mb-0">
                <strong>Subject:</strong> {{ group.subject }}
            </p>
        </div>
        <!-- Leave group button -->
        <a href="{{ url_for('leave_group', group_id=group.id) }}" class="btn btn-outline-danger btn-lg">Leave Group</a>
    </div>
    <!-- Group description -->
    <p class="mb-4">{{ group.description }}</p>

    <!-- Tabs (using your custom CSS) -->
    <div class="tabs">
        <button class="tab-link active" onclick="openTab(event, 'Chat')">Chat</button>
        <button class="tab-link" onclick="openTab(event, 'Resources')">Resources</button>
        <button class="tab-link" onclick="openTab(event, 'Events')">Events</button>
        <button class="tab-link" onclick="openTab(event, 'Members')">Members ({{ group.members|length }})</button>
    </div>

    <!-- Tab Content Container -->
    <div class="group-container">

        <!-- CHAT TAB -->
        <div id="Chat" class="tab-content" style="display: block;">
            <div class="chat-wrapper">
                <h3>Group Chat</h3>
                <!-- Chat messages (styled by your style.css) -->
                <div id="messages">
                    <!-- Messages will appear here -->
                </div>
                <!-- Bootstrap-styled chat form -->
                <form id="chat-form" class="d-flex gap-2">
                    <input id="message-input" type="text" placeholder="Enter message" class="form-control" autocomplete="off" required>
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>

        <!-- RESOURCES TAB -->
        <div id="Resources" class="tab-content">
            <div class="resource-wrapper">
                <h3>Add a New Resource</h3>
                <!-- Bootstrap-styled resource form -->
                <div class="card bg-light p-3 mb-4 border-0">
                    <form method="POST" action="{{ url_for('group_detail', group_id=group.id) }}" enctype="multipart/form-data"> {# Ensure action points correctly #}
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.title.label(class="form-label") }}
                            {{ form.title(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="3") }}
                        </div>
                        <div class="mb-3">
                            {{ form.resource_type.label(class="form-label") }}
                            {{ form.resource_type(class="form-select", id="resource_type_select") }} {# Use form-select for dropdowns #}
                        </div>
                        <div class="mb-3" id="url_field">
                            {{ form.url.label(class="form-label") }}
                            {{ form.url(class="form-control") }}
                        </div>
                        <div class="mb-3" id="file_field">
                            {{ form.file.label(class="form-label") }}
                            {{ form.file(class="form-control") }} {# Bootstrap styles file inputs too #}
                        </div>
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>

                <hr class="my-4">

                <h3>All Resources</h3>
                <!-- Bootstrap-styled resource list (as cards in a grid) -->
                <div class="resource-list">
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                        {% for resource in resources|reverse %} {# Use the passed resources variable #}
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ resource.title }}</h5>
                                        <p class="card-text">{{ resource.description }}</p>
                                        <p class="card-text"><small class="text-muted">Posted by: {{ resource.poster.username }}</small></p>

                                        <div class="d-flex gap-2">
                                            {% if resource.resource_type == 'link' %}
                                                <a href="{{ resource.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Go to Link</a> {# Use btn-sm for smaller buttons #}
                                            {% elif resource.resource_type == 'file' %}
                                                <a href="{{ url_for('download_file', filename=resource.filename) }}"
                                                   class="btn btn-outline-primary btn-sm"
                                                   download
                                                   onclick="this.textContent='Downloading...'">
                                                    Download File
                                                </a>
                                            {% endif %}

                                            {% if current_user == resource.poster %}
                                                <form action="{{ url_for('delete_resource', resource_id=resource.id) }}" method="POST" style="margin: 0;">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure?')">
                                                        Delete
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-12">
                                <p class="text-muted">No resources have been shared in this group yet.</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- EVENTS TAB -->
        <div id="Events" class="tab-content">
             <h3>Add New Event</h3>
            <!-- Event Form -->
            <div class="card bg-light p-3 mb-4 border-0">
                <form method="POST" action="{{ url_for('create_event', group_id=group.id) }}">
                    {{ event_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ event_form.title.label(class="form-label") }}
                        {{ event_form.title(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ event_form.description.label(class="form-label") }}
                        {{ event_form.description(class="form-control", rows="3") }}
                    </div>
                    <div class="row">
                    <div class="col-md-6 mb-3"> {# Date input #}
                            {{ event_form.event_date.label(class="form-label") }}
                            {{ event_form.event_date(class="form-control", type="date") }} {# Use type="date" #}
                            {# Optional: Add error display if needed #}
                        </div>
                        <div class="col-md-6 mb-3"> {# Time input #}
                            {{ event_form.event_time.label(class="form-label") }}
                            {{ event_form.event_time(class="form-control", type="time") }} {# Use type="time" #}
                            {# Optional: Add error display if needed #}
                        </div>
                    </div>
                    <div class="d-grid">
                        {{ event_form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>

            <hr class="my-4">

            <h3>Upcoming Events</h3>
            <!-- Event List -->
            <div class="list-group">
                {% for event in events %} {# Use the passed events variable #}
                    <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 shadow-sm border-start border-primary border-4">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">{{ event.title }}</h5>
                            <small class="text-muted">{{ event.event_datetime.strftime('%a, %b %d, %Y at %I:%M %p') }}</small>
                        </div>
                        <p class="mb-1">{{ event.description | default('No description provided.', true) }}</p>
                        <small class="text-muted d-block">Added by: {{ event.creator.username }}</small>
                        {% if event.creator == current_user %}
                        <div class="mt-2 d-flex gap-2">
                             <a href="{{ url_for('edit_event', event_id=event.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                             <form action="{{ url_for('delete_event', event_id=event.id) }}" method="POST" style="margin:0;">
                                 <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this event?')">Delete</button>
                             </form>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-muted">No upcoming events scheduled.</p>
                {% endfor %}
            </div>
        </div>
        <!-- END OF EVENTS TAB -->

        <!-- MEMBERS TAB -->
        <div id="Members" class="tab-content">
            <div class="member-list">
                <h3>Members</h3>
                <!-- Bootstrap "list group" -->
                <ul class="list-group list-group-flush">
                    {% for member in group.members %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            {{ member.username }}
                            {% if member == group.creator %}
                                <span class="badge bg-primary rounded-pill">Creator</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
{% endblock content %}


<!-- SCRIPTS -->
{% block scripts %}
    {{ super() }} <!-- Keep Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // --- TAB LOGIC ---
            function openTab(evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tab-link");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }
            document.querySelectorAll('.tab-link').forEach(button => {
                const tabName = button.textContent.split('(')[0].trim();
                button.onclick = (event) => openTab(event, tabName);
            });

            // --- RESOURCE FORM LOGIC ---
            const resourceTypeSelect = document.getElementById('resource_type_select');
            const urlField = document.getElementById('url_field');
            const fileField = document.getElementById('file_field');
            function toggleFields() {
                if (resourceTypeSelect.value === 'link') {
                    urlField.style.display = 'block'; fileField.style.display = 'none';
                } else if (resourceTypeSelect.value === 'file') {
                    urlField.style.display = 'none'; fileField.style.display = 'block';
                }
            }
            if (resourceTypeSelect) { // Add check in case element isn't found
               toggleFields();
               resourceTypeSelect.addEventListener('change', toggleFields);
            }


            // --- CHAT LOGIC ---
            var socket = io();
            const room = '{{ group.id }}';
            const chatForm = document.getElementById('chat-form');
            const msgInput = document.getElementById('message-input');
            const messagesDiv = document.getElementById('messages');

            socket.on('connect', function() { socket.emit('join', {room: room}); });

            if (chatForm) { // Add check
                chatForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    let msgText = msgInput.value;
                    if (msgText.length > 0) {
                        socket.emit('send_message', {msg: msgText, room: room});
                        msgInput.value = '';
                    }
                });
            }

            socket.on('receive_message', function(data) {
                if (!messagesDiv) return; // Add check
                const msgElement = document.createElement('div');
                msgElement.classList.add('message');
                if (data.username === '{{ current_user.username }}') {
                    msgElement.classList.add('my-message');
                } else {
                    msgElement.classList.add('other-message');
                }
                // Basic sanitation to prevent HTML injection in messages
                const safeUsername = data.username.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const safeMsg = data.msg.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                msgElement.innerHTML = `<strong>${safeUsername}</strong><p>${safeMsg}</p>`;

                messagesDiv.appendChild(msgElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        });
    </script>
{% endblock %}